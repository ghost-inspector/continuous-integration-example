test:
    post:
        # Start our application
        - node server.js:
            background: true
        # Download ngrok and open tunnel to our application
        - wget https://dl.ngrok.com/ngrok_2.0.17_linux_amd64.zip
        - unzip ngrok_2.0.17_linux_amd64.zip
        - ./ngrok authtoken $NGROK_TOKEN
        - ./ngrok http -subdomain=$CIRCLE_SHA1 3000:
            background: true
        # Wait for application and ngrok to be ready
        - curl --retry 10 --retry-delay 2 -v https://$CIRCLE_SHA1.ngrok.io
        # Execute Ghost Inspector tests using the ngrok tunnel
        - curl "https://api.ghostinspector.com/v1/suites/$GHOST_SUITE_ID/execute/?apiKey=$GHOST_API_KEY&startUrl=https://$CIRCLE_SHA1.ngrok.io" > ghostinspector.json
        # Exit with a fail status if any tests have failed
        - if [ $(grep -c '"passing":false' ghostinspector.json) -ne 0 ]; then exit 1; fi
